(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const ae=(e,t)=>{const n=Math.ceil(Math.min(e,t)),r=Math.floor(Math.max(e,t)),o=Math.random()*(r-n+1)+n;return Math.floor(o)},de=e=>e[ae(0,e.length-1)],f=e=>e.key==="Escape",ue=e=>e.key==="Enter",me=(e,t=500)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e.apply(globalThis,r),t)}},pe=35,_e=35,fe=5,he=/^#[a-zа-яё0-9]{1,19}$/i,ge=/\s+/g,ye=5,H=140,Se=100,B=25,V=25,G=100,m={none:{name:"none",style:" ",min:0,max:100,step:1,unit:""},chrome:{name:"chrome",style:"grayscale",min:0,max:1,step:.1,unit:""},sepia:{name:"sepia",style:"sepia",min:0,max:1,step:.1,unit:""},marvin:{name:"marvin",style:"invert",min:0,max:100,step:1,unit:"%"},phobos:{name:"phobos",style:"blur",min:0,max:3,step:.1,unit:"px"},heat:{name:"heat",style:"brightness",min:1,max:3,step:.1,unit:""}},z="https://32.javascript.htmlacademy.pro/kekstagram",j={GET_DATA:"/data",SEND_DATA:"/"},x={IDLE:"Опубликовать",SENDING:"Публикация..."},Ee=5e3,ve=10,Le=500,a=document.querySelector(".big-picture"),I=a.querySelector(".big-picture__img img"),qe=a.querySelector(".likes-count"),we=a.querySelector(".social__caption"),Te=a.querySelector(".social__comment-shown-count"),be=a.querySelector(".social__comment-total-count"),K=a.querySelector(".social__comments"),w=a.querySelector(".comments-loader"),T=[];let y=0,W=0;const Ce=({avatar:e,message:t,name:n})=>{const r=document.createElement("li");r.classList.add("social__comment"),r.innerHTML='<img class="social__picture"><p class="social__text"></p>';const o=r.querySelector(".social__picture");o.src=e,o.alt=n,o.width=pe,o.height=_e;const s=r.querySelector(".social__text");return s.textContent=t,r},Ae=()=>{y<W?w.classList.remove("hidden"):w.classList.add("hidden")},ke=()=>{Te.textContent=y},X=()=>{const e=document.createDocumentFragment();T.splice(0,fe).forEach(t=>{e.append(Ce(t)),y++}),K.append(e),Ae(),ke()},De=({likes:e,comments:t,url:n,description:r})=>{I.src=n,I.alt=r,qe.textContent=e,we.textContent=r,be.textContent=t.length,T.length=0,y=0,T.push(...t.slice()),K.innerHTML="",W=t.length,X()};w.addEventListener("click",X);const A=document.querySelector(".big-picture"),Y=A.querySelector(".cancel"),Fe=e=>{A.classList.remove("hidden"),document.body.classList.add("modal-open"),document.addEventListener("keydown",J),De(e)},k=()=>{A.classList.add("hidden"),document.body.classList.remove("modal-open"),document.removeEventListener("keydown",J)};function J(e){f(e)&&(e.preventDefault(),k())}Y.addEventListener("click",()=>{k()});Y.addEventListener("keydown",e=>{ue(e)&&k()});const Q=document.querySelector(".pictures"),Me=document.querySelector("#picture").content.querySelector(".picture"),b=[],Ne=()=>{document.querySelectorAll(".picture").forEach(e=>e.remove())},S=e=>{Ne(),b.length=0,b.push(...e.slice());const t=document.createDocumentFragment();e.forEach(({id:n,url:r,description:o,likes:s,comments:c})=>{const i=Me.cloneNode(!0);i.querySelector(".picture__img").src=r,i.querySelector(".picture__img").alt=o,i.querySelector(".picture__likes").textContent=s,i.querySelector(".picture__comments").textContent=c.length,i.dataset.marker=n,t.appendChild(i)}),Q.append(t)};Q.addEventListener("click",e=>{const t=e.target.closest(".picture");if(t){const n=Number(t.dataset.marker),r=b.find(o=>o.id===n);Fe(r)}});const Pe=document.querySelector("#data-error").content.querySelector(".data-error"),xe=()=>{const e=Pe.cloneNode(!0);document.body.appendChild(e),setTimeout(()=>{e.remove()},Ee)},d=document.querySelector(".img-filters"),Ie=d.querySelector(".img-filters__form"),Re=d.querySelector("#filter-default"),$e=d.querySelector("#filter-random"),Oe=d.querySelector("#filter-discussed"),Ue=()=>{d.classList.remove("img-filters--inactive")},He=e=>{d.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),e.classList.add("img-filters__button--active")},Be=e=>{S(e)},Ve=e=>{const t=[];for(;t.length!==ve;){const n=de(e);t.includes(n)||t.push(n)}S(t)},Ge=e=>{const r=e.map(o=>({id:o.id,comments:o.comments.length})).sort((o,s)=>o.comments>s.comments?-1:o.comments<s.comments?1:0).map(o=>e[o.id]);S(r)},ze=e=>{Ie.addEventListener("click",me(t=>{t.target===Re&&Be(e),t.target===$e&&Ve(e),t.target===Oe&&Ge(e)},Le))};d.addEventListener("click",e=>{e.target.classList.contains("img-filters__button")&&He(e.target)});const je=e=>{fetch(`${z}${j.GET_DATA}`).then(t=>{if(!t.ok)throw new Error;return t.json()}).then(t=>{e(t),Ue(),ze(t)}).catch(()=>xe())},Ke=e=>fetch(`${z}${j.SEND_DATA}`,{method:"POST",body:e}),D=document.querySelector(".img-upload__form"),E=D.querySelector(".text__hashtags"),Z=D.querySelector(".text__description"),p=new Pristine(D,{classTo:"img-upload__field-wrapper",errorTextParent:"img-upload__field-wrapper",errorTextClass:"img-upload__field-error"}),F=e=>e.length?E.value.toLowerCase().replaceAll(ge," ").trim().split(" "):[],We=e=>F(e).every(n=>he.test(n)),Xe=e=>{const t=F(e),n=[...new Set(t)];return t.length===n.length},Ye=e=>F(e).length<=ye;p.addValidator(E,We,"Хэштег состоит из букв и цифр, максимальная длина 20 символов",1,!0);p.addValidator(E,Xe,"Хэштеги не могут повторяться",2,!0);p.addValidator(E,Ye,"Разрешено не более пяти хэштегов",3,!0);const Je=()=>Z.value.length<=H;p.addValidator(Z,Je,`Длина комментария не может превышать ${H} символов`);const Qe=()=>p.validate(),Ze=()=>{p.reset()},v=document.querySelector(".img-upload__preview-container"),ee=v.querySelector(".scale__control--smaller"),te=v.querySelector(".scale__control--bigger"),oe=v.querySelector(".scale__control--value"),et=v.querySelector(".img-upload__preview img");let l=parseInt(oe.value,10);const ne=()=>{ee.disabled=l<=V,te.disabled=l>=G},M=e=>{oe.value=`${e}%`,et.style.transform=`scale(${e/100})`};ee.addEventListener("click",()=>{l>V&&(l-=B,M(l),ne())});te.addEventListener("click",()=>{l<G&&(l+=B,M(l),ne())});const tt=()=>{M(Se)},_=document.querySelector(".img-upload__wrapper"),C=_.querySelector(".img-upload__preview img"),ot=_.querySelector(".effects__list"),re=_.querySelector(".img-upload__effect-level"),h=_.querySelector(".effect-level__slider"),R=_.querySelector(".effect-level__value"),nt=Object.keys(m).map(e=>m[e]),se=({style:e,max:t,unit:n})=>{C.style.filter="",C.style.filter=`${e}(${t}${n})`},N=()=>{re.classList.add("hidden")},rt=()=>{re.classList.remove("hidden")},st=()=>{const e=_.querySelector(".effects__radio:checked").value;R.value=h.noUiSlider.get(),C.style.filter=`${m[e].style}(${R.value}${m[e].unit})`},ct=({max:e,min:t,step:n})=>{noUiSlider.create(h,{range:{min:t,max:e},start:e,step:n,connect:"lower",format:{to:r=>Number(r),from:r=>Number(r)}}),h.noUiSlider.on("update",st),N()},it=({min:e,max:t,step:n})=>{h.noUiSlider.updateOptions({range:{min:e,max:t},start:t,step:n})};ot.addEventListener("change",e=>{const t=nt.find(n=>n.name===e.target.value);se(t),it(t),e.target.value!=="none"?rt():N()});const lt=()=>{se(m.none),N()},$=document.querySelector(".img-upload__submit"),at=document.querySelector("#error").content.querySelector(".error"),L=at.cloneNode(!0),dt=document.querySelector("#success").content.querySelector(".success"),q=dt.cloneNode(!0),ce=(e,t,n)=>{document.removeEventListener("keydown",g),document.addEventListener("keydown",o),document.addEventListener("click",s);const r=()=>{e.remove(),document.removeEventListener("click",s),document.removeEventListener("keydown",o),e.classList.contains("error")&&document.addEventListener("keydown",g),t.removeEventListener("click",r)};function o(c){f(c)&&(c.preventDefault(),r())}function s(c){const i=c.target.closest(n);c.target!==i&&r()}t.addEventListener("click",r)},ut=()=>{document.body.appendChild(L);const e=L.querySelector(".error__button");ce(L,e,".error__inner")},mt=()=>{document.body.appendChild(q);const e=q.querySelector(".success__button");ce(q,e,".success__inner")},O=(e=!0)=>{$.disabled=e,$.textContent=e?x.SENDING:x.IDLE},u=document.querySelector(".img-upload__form"),ie=u.querySelector(".img-upload__input"),le=u.querySelector(".img-upload__overlay"),pt=u.querySelector(".img-upload__cancel"),_t=u.querySelector(".text__hashtags"),ft=u.querySelector(".text__description"),ht=()=>{le.classList.remove("hidden"),document.body.classList.add("modal-open"),document.addEventListener("keydown",g)},P=()=>{le.classList.add("hidden"),document.body.classList.remove("modal-open"),ie.value="",document.removeEventListener("keydown",g),Ze(),tt(),lt(),u.reset()};ie.addEventListener("change",()=>{ht()});pt.addEventListener("click",()=>{P()});function g(e){f(e)&&(e.preventDefault(),P())}_t.addEventListener("keydown",e=>{f(e)&&e.stopPropagation()});ft.addEventListener("keydown",e=>{f(e)&&e.stopPropagation()});u.addEventListener("submit",e=>{if(e.preventDefault(),Qe()){O();const t=new FormData(e.target);Ke(t).then(n=>{if(!n.ok)throw new Error;P(),mt()}).catch(()=>ut()).finally(()=>{O(!1)})}});ct(m.none);const gt=["jpg","jpeg","png"],U=document.querySelector(".img-upload__input"),yt=document.querySelector(".img-upload__preview img"),St=document.querySelectorAll(".effects__preview");U.addEventListener("change",()=>{const e=U.files[0],t=e.name.toLowerCase();if(gt.some(r=>t.endsWith(r))){const r=URL.createObjectURL(e);yt.src=r,St.forEach(o=>{o.style.backgroundImage=`url(${r})`})}});je(S);
